name: PHP

on:
  push:
    branches: [ master, mike/php-8.2-ci ]
  pull_request:
    branches: [ master ]

jobs:
  linting:
    name: Linting
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Set up PHP 7.0
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
    - name: Install php code sniffer
      run: composer require "squizlabs/php_codesniffer=*"
    - name: Run linting
      run: composer lint

  integration_tests:
    name: Integration Tests
    uses: optimizely/php-sdk/.github/workflows/integration_test.yml@uzair/test-with-fsc
    secrets:
      CI_USER_TOKEN: ${{ secrets.CI_USER_TOKEN }}
      TRAVIS_COM_TOKEN: ${{ secrets.TRAVIS_COM_TOKEN }}

  unit_tests:
    name: Unit Tests ${{ matrix.php-versions }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php-versions: [ '7.4', '8.0', '8.1', '8.2', '8.3' ]
    steps:
    - uses: actions/checkout@v3
    - name: Set up PHP v${{ matrix.php-versions }}
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php-versions }}
    - name: Cache Composer packages
      id: composer-cache
      uses: actions/cache@v3
      with:
        path: vendor
        key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-
    - name: Install dependencies
      run: composer install
    - name: run tests
      run: |
        mkdir -p build/logs
        ./vendor/bin/phpunit --coverage-clover build/logs/clover.xml
    - name: Upload coverage results to Coveralls
      env:
        COVERALLS_REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        composer global require php-coveralls/php-coveralls
        php-coveralls --coverage_clover=build/logs/clover.xml -v
