name: PHP

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  linting:
    name: Linting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
      - name: Install php code sniffer
        run: composer require "squizlabs/php_codesniffer=*"
      - name: Run linting
        run: composer lint

  integration_tests:
    name: Integration Tests
    uses: optimizely/php-sdk/.github/workflows/integration_test.yml@uzair/test-with-fsc
    secrets:
      CI_USER_TOKEN: ${{ secrets.CI_USER_TOKEN }}
      TRAVIS_COM_TOKEN: ${{ secrets.TRAVIS_COM_TOKEN }}

  unit_tests:
    name: Unit Tests ${{ matrix.php-versions }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php-versions: [ '8.0', '8.1', '8.2' ]
    steps:
      - uses: actions/checkout@v3
      - name: Set up PHP v${{ matrix.php-versions }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-versions }}
      - name: Cache Composer packages
        id: composer-cache
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-
      - name: Install dependencies
        run: composer install
      - name: Create build/logs directory
        run: mkdir -p ./build/logs
      - name: Run unit tests
        uses: php-actions/phpunit@v3
        env:
          XDEBUG_MODE: coverage
        with:
          configuration: phpunit.xml
          php_extensions: xdebug
          version: 8.5
          php_version: ${{ matrix.php-versions }}
          memory_limit: 256M
          coverage_clover: ./build/logs/clover.xml
          bootstrap: phpunit_bootstrap.php
      - name: Verify clover.xml created
        run: |
          if [ ! -f ./build/logs/clover.xml ]; then
            echo "clover.xml was not created"
            exit 1
          fi
      - name: Upload coverage results to Coveralls
        env:
          COVERALLS_REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          composer global require php-coveralls/php-coveralls
          php-coveralls --coverage_clover=./build/logs/clover.xml -v
